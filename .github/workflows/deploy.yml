# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

# Deployment workflow for pushes to main branch.
name: Deploy

# TODO: ideally, trigger on tags for production releases. however, Azure Container Apps GitHub integration does not support dynamic tag refs
# https://learn.microsoft.com/en-us/azure/container-apps/github-actions
on:
  push:
    branches: [ main, deploy-correct-image ]
  workflow_dispatch:

# Set up permissions for deploying with secretless Azure federated credentials
# https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-portal%2Clinux#set-up-azure-login-with-openid-connect-authentication
permissions:
  id-token: write
  contents: write

env:
  CONTAINER_IMAGE_NAME: ghcr.io/cooperlutz/go-full
  IMAGE_NAME: ${{ github.repository }}
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_DEV_COLLECT_TELEMETRY: no

jobs:
  cd:
    name: Deploy Latest Image to Azure
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    steps:

      - name: Setup / Check out code 
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup / Check out code into the Go module directory
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup / pnpm for frontend build
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          version: 10
          run_install: false

      - name: Setup / Install frontend dependencies
        run: pnpm install
        working-directory: ./api/frontend

      - name: Deploy / Setup / Install azd
        uses: Azure/setup-azd@v2

      # - name: Deploy / Setup / Log in with Azure (Federated Credentials)
      #   run: |
      #     azd auth login `
      #       --client-id "$Env:AZURE_CLIENT_ID" `
      #       --federated-credential-provider "github" `
      #       --tenant-id "$Env:AZURE_TENANT_ID"
      #   shell: pwsh

      - name: Get latest image digest for the container image
        id: get_image_digest
        run: |
          echo "Getting latest image digest for $IMAGE_NAME..."
          MANIFEST_FOR_LATEST=$(docker manifest inspect $CONTAINER_IMAGE_NAME:latest)
          SHA_FOR_AMD64_LATEST=$(yq '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest' -P <<< "$MANIFEST_FOR_LATEST")  
          echo "SHA for AMD64 latest: $SHA_FOR_AMD64_LATEST"
          LATEST_IMAGE_WITH_DIGEST="$CONTAINER_IMAGE_NAME@$SHA_FOR_AMD64_LATEST"
          echo "CONTAINER_IMAGE=$LATEST_IMAGE_WITH_DIGEST" >> $GITHUB_ENV

      - name: Deploy / Provision Immutable Azure Infrastructure
        run: azd provision -C ./deploy/azure --no-prompt --no-state
        env:
          APPLICATION_NAME: "go-full"
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          CONTAINER_REG_PAT: ${{ secrets.CONTAINER_REG_PAT }}
          CONTAINER_REG_USERNAME: ${{ vars.CONTAINER_REG_USERNAME }}
          ALLOWED_INBOUND_IP: ${{ secrets.ALLOWED_INBOUND_IP }}
          DB_USER: ${{ vars.DB_USER }}
          DB_TYPE: ${{ vars.DB_TYPE }}
          DB_NAME: ${{ vars.DB_NAME }}
          DB_SSLMODE: ${{ vars.DB_SSLMODE }}
          HTTP_PORT: ${{ vars.HTTP_PORT }}
          SEC_JWT_SECRET: ${{ secrets.SEC_JWT_SECRET }}

      # - name: Deploy / Deploy Container App
      #   run: make deploy

      - name: Output AZD Info
        run: azd show -C ./deploy/azure
